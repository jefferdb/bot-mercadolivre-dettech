<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Mercado Livre - DETTECH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div x-data="botApp()" x-init="init()" class="min-h-screen">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-robot text-2xl"></i>
                        <div>
                            <h1 class="text-2xl font-bold">Bot Mercado Livre</h1>
                            <p class="text-blue-200">DETTECH - Sistema Aprimorado</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="text-sm text-blue-200">Status da Conexão</div>
                            <div class="flex items-center space-x-2">
                                <div :class="connectionStatus ? 'bg-green-400' : 'bg-red-400'" class="w-3 h-3 rounded-full"></div>
                                <span x-text="connectionStatus ? 'Conectado' : 'Desconectado'" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4">
                <div class="flex space-x-8">
                    <button @click="activeTab = 'dashboard'" 
                            :class="activeTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button @click="activeTab = 'rules'" 
                            :class="activeTab === 'rules' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-cogs mr-2"></i>Regras
                    </button>
                    <button @click="activeTab = 'questions'" 
                            :class="activeTab === 'questions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-question-circle mr-2"></i>Perguntas
                    </button>
                    <button @click="activeTab = 'quality'" 
                            :class="activeTab === 'quality' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-star mr-2"></i>Qualidade
                    </button>
                    <button @click="activeTab = 'absence'" 
                            :class="activeTab === 'absence' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-moon mr-2"></i>Ausência
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Dashboard Tab -->
            <div x-show="activeTab === 'dashboard'" class="space-y-8">
                <!-- Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-question-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total de Perguntas</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="realtimeStats.total_questions || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Respondidas</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="realtimeStats.answered_questions || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Aguardando</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="realtimeStats.pending_questions || 0"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-cogs text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Regras Ativas</p>
                                <p class="text-2xl font-semibold text-gray-900" x-text="realtimeStats.active_rules || 0"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Taxa de Sucesso</h3>
                        <div class="flex items-center">
                            <div class="text-3xl font-bold text-green-600" x-text="realtimeStats.success_rate + '%'"></div>
                            <div class="ml-4 text-sm text-gray-600">das perguntas respondidas com sucesso</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Tempo Médio de Resposta</h3>
                        <div class="flex items-center">
                            <div class="text-3xl font-bold text-blue-600" x-text="realtimeStats.avg_response_time + 's'"></div>
                            <div class="ml-4 text-sm text-gray-600">tempo médio para responder</div>
                        </div>
                    </div>
                </div>

                <!-- Token Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Status do Token</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-sm text-gray-600">Válido</div>
                            <div :class="tokenStatus.is_valid ? 'text-green-600' : 'text-red-600'" class="font-semibold">
                                <i :class="tokenStatus.is_valid ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                <span x-text="tokenStatus.is_valid ? 'Sim' : 'Não'"></span>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">Expira em</div>
                            <div class="font-semibold text-gray-900" x-text="tokenStatus.time_until_expiry || 'N/A'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-gray-600">Precisa Renovar</div>
                            <div :class="tokenStatus.needs_renewal ? 'text-orange-600' : 'text-green-600'" class="font-semibold">
                                <span x-text="tokenStatus.needs_renewal ? 'Sim' : 'Não'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rules Tab -->
            <div x-show="activeTab === 'rules'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Regras de Resposta</h2>
                    <button @click="showRuleModal = true; editingRule = null" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>Nova Regra
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Palavras-chave</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="rule in rules" :key="rule.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="rule.name"></td>
                                    <td class="px-6 py-4 text-sm text-gray-500">
                                        <div class="flex flex-wrap gap-1">
                                            <template x-for="keyword in rule.keywords.slice(0, 3)" :key="keyword">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" x-text="keyword"></span>
                                            </template>
                                            <span x-show="rule.keywords.length > 3" class="text-xs text-gray-400" x-text="'+' + (rule.keywords.length - 3) + ' mais'"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="rule.priority"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="rule.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                            <span x-text="rule.active ? 'Ativa' : 'Inativa'"></span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="editRule(rule)" class="text-blue-600 hover:text-blue-900">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="deleteRule(rule.id)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Questions Tab -->
            <div x-show="activeTab === 'questions'" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Perguntas Recentes</h2>
                
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Histórico de Perguntas</h3>
                            <div class="flex space-x-2">
                                <button @click="loadRecentQuestions()" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-refresh mr-1"></i>Atualizar
                                </button>
                                <button @click="resetQuestions()" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash mr-1"></i>Resetar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divide-y divide-gray-200">
                        <template x-for="question in recentQuestions" :key="question.id">
                            <div class="p-6">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="text-sm font-medium text-gray-900">ID: <span x-text="question.id"></span></span>
                                            <span :class="question.status === 'ANSWERED' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" 
                                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                                <span x-text="question.status === 'ANSWERED' ? 'Respondida' : 'Aguardando'"></span>
                                            </span>
                                            <span x-show="question.rule_name" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                <span x-text="question.rule_name"></span>
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-900 mb-2">
                                            <strong>Pergunta:</strong> <span x-text="question.text"></span>
                                        </div>
                                        <div x-show="question.answer_text" class="text-sm text-gray-600 mb-2">
                                            <strong>Resposta:</strong> <span x-text="question.answer_text"></span>
                                        </div>
                                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                                            <span x-text="formatDate(question.date_created)"></span>
                                            <span x-show="question.response_time">Tempo: <span x-text="question.response_time + 's'"></span></span>
                                            <span x-show="question.keywords_matched && question.keywords_matched.length">
                                                Palavras-chave: <span x-text="question.keywords_matched.join(', ')"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Quality Tab -->
            <div x-show="activeTab === 'quality'" class="space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Monitoramento de Qualidade</h2>
                
                <!-- Quality Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Uso por Regra</h3>
                        <div class="space-y-3">
                            <template x-for="stat in qualityMetrics.rule_stats" :key="stat.rule_name">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600" x-text="stat.rule_name"></span>
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-gray-900" x-text="stat.usage_count + ' usos'"></div>
                                        <div class="text-xs text-gray-500" x-text="stat.avg_response_time + 's médio'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Palavras-chave</h3>
                        <div class="space-y-2">
                            <template x-for="keyword in qualityMetrics.top_keywords" :key="keyword.keyword">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-600" x-text="keyword.keyword"></span>
                                    <span class="text-sm font-medium text-gray-900" x-text="keyword.count"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Absence Tab -->
            <div x-show="activeTab === 'absence'" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">Respostas de Ausência</h2>
                    <button @click="showAbsenceModal = true; editingAbsence = null" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>Nova Configuração
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dias Úteis</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="absence in absenceResponses" :key="absence.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="absence.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="absence.start_time + ' - ' + absence.end_time"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <span x-text="absence.weekdays_only ? 'Sim' : 'Não'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="absence.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                            <span x-text="absence.active ? 'Ativa' : 'Inativa'"></span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                        <button @click="editAbsence(absence)" class="text-blue-600 hover:text-blue-900">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @click="deleteAbsence(absence.id)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Rule Modal -->
        <div x-show="showRuleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingRule ? 'Editar Regra' : 'Nova Regra'"></h3>
                    
                    <form @submit.prevent="saveRule()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome</label>
                                <input x-model="ruleForm.name" type="text" required 
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Palavras-chave (uma por linha)</label>
                                <textarea x-model="ruleForm.keywordsText" rows="4" required
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Resposta</label>
                                <textarea x-model="ruleForm.response_text" rows="4" required
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Prioridade</label>
                                    <input x-model="ruleForm.priority" type="number" min="0" max="100"
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="flex items-center">
                                    <input x-model="ruleForm.active" type="checkbox" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Ativa</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button @click="showRuleModal = false" type="button" 
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Absence Modal -->
        <div x-show="showAbsenceModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" x-text="editingAbsence ? 'Editar Configuração' : 'Nova Configuração'"></h3>
                    
                    <form @submit.prevent="saveAbsence()">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome</label>
                                <input x-model="absenceForm.name" type="text" required 
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Mensagem de Ausência</label>
                                <textarea x-model="absenceForm.message" rows="4" required
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Horário Início</label>
                                    <input x-model="absenceForm.start_time" type="time" required
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Horário Fim</label>
                                    <input x-model="absenceForm.end_time" type="time" required
                                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input x-model="absenceForm.weekdays_only" type="checkbox" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Apenas dias úteis</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input x-model="absenceForm.active" type="checkbox" 
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-900">Ativa</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button @click="showAbsenceModal = false" type="button" 
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                                Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function botApp() {
            return {
                activeTab: 'dashboard',
                connectionStatus: false,
                loading: false,
                
                // Data
                realtimeStats: {},
                qualityMetrics: {},
                recentQuestions: [],
                rules: [],
                absenceResponses: [],
                tokenStatus: {},
                
                // Modals
                showRuleModal: false,
                showAbsenceModal: false,
                editingRule: null,
                editingAbsence: null,
                
                // Forms
                ruleForm: {
                    name: '',
                    keywordsText: '',
                    response_text: '',
                    priority: 5,
                    active: true
                },
                absenceForm: {
                    name: '',
                    message: '',
                    start_time: '09:00',
                    end_time: '18:00',
                    weekdays_only: true,
                    active: false
                },

                async init() {
                    await this.loadData();
                    // Auto-refresh every 30 seconds
                    setInterval(() => this.loadData(), 30000);
                },

                async loadData() {
                    try {
                        await Promise.all([
                            this.loadRealtimeStats(),
                            this.loadQualityMetrics(),
                            this.loadRecentQuestions(),
                            this.loadRules(),
                            this.loadAbsenceResponses(),
                            this.loadTokenStatus()
                        ]);
                        this.connectionStatus = true;
                    } catch (error) {
                        console.error('Error loading data:', error);
                        this.connectionStatus = false;
                    }
                },

                async loadRealtimeStats() {
                    const response = await fetch('/api/ml/statistics/realtime');
                    const data = await response.json();
                    if (data.success) {
                        this.realtimeStats = data.statistics;
                    }
                },

                async loadQualityMetrics() {
                    const response = await fetch('/api/ml/statistics/quality');
                    const data = await response.json();
                    if (data.success) {
                        this.qualityMetrics = data.metrics;
                    }
                },

                async loadRecentQuestions() {
                    const response = await fetch('/api/ml/questions/recent?limit=20');
                    const data = await response.json();
                    if (data.success) {
                        this.recentQuestions = data.questions;
                    }
                },

                async resetQuestions() {
                    if (!confirm('Tem certeza que deseja resetar todas as perguntas? Esta ação não pode ser desfeita.\n\nSerão removidos:\n- Todas as perguntas\n- Histórico de respostas\n- Logs de atividade\n\nSerão mantidas:\n- Regras de resposta\n- Configurações de ausência\n- Credenciais')) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/ml/questions/reset', {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Mostrar mensagem de sucesso
                            alert(`Dashboard resetado com sucesso!\n\nRemovidos:\n- ${data.removed.questions} perguntas\n- ${data.removed.logs} logs\n- ${data.removed.quality_records} registros de qualidade\n\nConfiguração preservadas: ${data.preserved.rules}, ${data.preserved.absence_config}`);
                            
                            // Recarregar dados
                            await this.loadRecentQuestions();
                            await this.loadStatistics();
                            
                        } else {
                            alert('Erro ao resetar dashboard: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Erro ao resetar:', error);
                        alert('Erro ao resetar dashboard. Verifique a conexão.');
                    }
                },

                async loadRules() {
                    const response = await fetch('/api/ml/rules');
                    const data = await response.json();
                    if (data.success) {
                        this.rules = data.rules;
                    }
                },

                async loadAbsenceResponses() {
                    try {
                        // Adicionar timestamp para evitar cache
                        const timestamp = new Date().getTime();
                        const response = await fetch(`/api/ml/absence?_t=${timestamp}`);
                        const data = await response.json();
                        if (data.success) {
                            this.absenceResponses = data.absence_responses;
                            console.log('Configurações de ausência carregadas:', this.absenceResponses);
                        } else {
                            console.error('Erro ao carregar configurações de ausência:', data.error);
                        }
                    } catch (error) {
                        console.error('Erro ao carregar configurações de ausência:', error);
                    }
                },

                async loadTokenStatus() {
                    // Simular status do token - você pode implementar uma rota específica
                    this.tokenStatus = {
                        is_valid: true,
                        time_until_expiry: '5h 30m',
                        needs_renewal: false
                    };
                },

                editRule(rule) {
                    this.editingRule = rule;
                    this.ruleForm = {
                        name: rule.name,
                        keywordsText: rule.keywords.join('\n'),
                        response_text: rule.response_text,
                        priority: rule.priority,
                        active: rule.active
                    };
                    this.showRuleModal = true;
                },

                async saveRule() {
                    try {
                        const keywords = this.ruleForm.keywordsText.split('\n').filter(k => k.trim());
                        const ruleData = {
                            name: this.ruleForm.name,
                            keywords: keywords,
                            response_text: this.ruleForm.response_text,
                            priority: parseInt(this.ruleForm.priority),
                            active: this.ruleForm.active
                        };

                        let response;
                        if (this.editingRule) {
                            response = await fetch(`/api/ml/rules/${this.editingRule.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(ruleData)
                            });
                        } else {
                            response = await fetch('/api/ml/rules', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(ruleData)
                            });
                        }

                        const data = await response.json();
                        if (data.success) {
                            this.showRuleModal = false;
                            await this.loadRules();
                            this.resetRuleForm();
                        } else {
                            alert('Erro ao salvar regra: ' + data.error);
                        }
                    } catch (error) {
                        alert('Erro ao salvar regra: ' + error.message);
                    }
                },

                async deleteRule(ruleId) {
                    if (confirm('Tem certeza que deseja excluir esta regra?')) {
                        try {
                            const response = await fetch(`/api/ml/rules/${ruleId}`, {
                                method: 'DELETE'
                            });
                            const data = await response.json();
                            if (data.success) {
                                await this.loadRules();
                            } else {
                                alert('Erro ao excluir regra: ' + data.error);
                            }
                        } catch (error) {
                            alert('Erro ao excluir regra: ' + error.message);
                        }
                    }
                },

                editAbsence(absence) {
                    this.editingAbsence = absence;
                    this.absenceForm = {
                        name: absence.name,
                        message: absence.message,
                        start_time: absence.start_time,
                        end_time: absence.end_time,
                        weekdays_only: absence.weekdays_only,
                        active: absence.active
                    };
                    this.showAbsenceModal = true;
                },

                async saveAbsence() {
                    try {
                        console.log('Salvando configuração de ausência:', this.absenceForm);
                        
                        let response;
                        if (this.editingAbsence) {
                            console.log('Editando ausência ID:', this.editingAbsence.id);
                            response = await fetch(`/api/ml/absence/${this.editingAbsence.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.absenceForm)
                            });
                        } else {
                            console.log('Criando nova ausência');
                            response = await fetch('/api/ml/absence', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.absenceForm)
                            });
                        }

                        const data = await response.json();
                        console.log('Resposta do servidor:', data);
                        
                        if (data.success) {
                            this.showAbsenceModal = false;
                            this.editingAbsence = null;
                            this.resetAbsenceForm();
                            
                            // Forçar recarregamento dos dados
                            await this.loadAbsenceResponses();
                            
                            // Mostrar mensagem de sucesso
                            alert('Configuração salva com sucesso!');
                        } else {
                            alert('Erro ao salvar configuração: ' + (data.error || 'Erro desconhecido'));
                        }
                    } catch (error) {
                        console.error('Erro ao salvar configuração:', error);
                        alert('Erro ao salvar configuração: ' + error.message);
                    }
                },

                async deleteAbsence(absenceId) {
                    if (confirm('Tem certeza que deseja excluir esta configuração de ausência?')) {
                        try {
                            const response = await fetch(`/api/ml/absence/${absenceId}`, {
                                method: 'DELETE'
                            });
                            const data = await response.json();
                            if (data.success) {
                                await this.loadAbsenceResponses();
                                alert('Configuração excluída com sucesso!');
                            } else {
                                alert('Erro ao excluir configuração: ' + (data.error || 'Erro desconhecido'));
                            }
                        } catch (error) {
                            console.error('Erro ao excluir configuração:', error);
                            alert('Erro ao excluir configuração: ' + error.message);
                        }
                    }
                },

                resetRuleForm() {
                    this.ruleForm = {
                        name: '',
                        keywordsText: '',
                        response_text: '',
                        priority: 5,
                        active: true
                    };
                },

                resetAbsenceForm() {
                    this.absenceForm = {
                        name: '',
                        message: '',
                        start_time: '09:00',
                        end_time: '18:00',
                        weekdays_only: true,
                        active: false
                    };
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleString('pt-BR');
                }
            }
        }
    </script>
</body>
</html>

